[include beacon.cfg]
[include mainsail.cfg]
#[include m8p_2.0.cfg]
[include macros.cfg]
#[include klicky-probe.cfg]
#[include brush.cfg]
#[include K-ShakeTune/*.cfg]
[include chamberlight.cfg]
[include fan.cfg]

[exclude_object]

[force_move]
enable_force_move: True

[idle_timeout]
timeout: 1800

[mcu]
canbus_uuid: d7119284a049

[mcu fly]
canbus_uuid: f6c6c927268c

[mcu host]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: fly:PA9
spi_bus: spi2

[resonance_tester]
accel_chip: adxl345
probe_points:
    150,150,20 

[input_shaper]
shaper_freq_x: 77.0
shaper_type_x: mzv
shaper_freq_y: 51.4
shaper_type_y: mzv


[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 3000             
max_z_velocity: 15          
max_z_accel: 350
square_corner_velocity: 5.0

[temperature_sensor CM4]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor M8P_2.0]
sensor_type: temperature_mcu

[temperature_sensor chamber]
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PC5

[temperature_sensor FlyV2]
sensor_type: temperature_mcu
sensor_mcu: fly

[heater_bed]
heater_pin: PA0
sensor_type: Generic 3950
sensor_pin: PB0
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

[verify_heater heater_bed]
max_error: 120
check_gain_time: 90
hysteresis: 5
heating_gain: 2


[bed_mesh]
speed: 500
horizontal_move_z: 19.85
mesh_min: 20, 20
mesh_max: 280,280
#fade_start: 0.26
#fade_end: 2
probe_count: 5,5
algorithm: bicubic
bicubic_tension: 0.2
#relative_reference_index: 12



#[probe]
#pin: ^fly:PA1
#x_offset: 0
#y_offset: 0
#z_offset: 0
#speed: 8.0
#samples: 3
#samples_result: median
#lift_speed: 12
#sample_retract_dist: 3.0
#samples_tolerance: 0.010
#samples_tolerance_retries: 3
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}#

#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}


[extruder]
step_pin: fly:PB4
dir_pin: !fly:PB3
enable_pin: !fly:PA15
rotation_distance: 22
gear_ratio: 50:10               #BMG Gear Ratio
microsteps: 32
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.600
filament_diameter: 1.75
heater_pin: fly:PA8
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: fly:PA3
min_temp: 10
max_temp: 320
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 250
max_extrude_only_velocity: 75.0
max_extrude_only_accel: 2500
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721
pressure_advance: 0.034
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
uart_pin: fly:PB5
run_current: 0.4

#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2504ac
#voltage: 36

#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2504ac
#voltage: 36

#Motor1
[stepper_x]
step_pin: PE6
dir_pin: PE5
enable_pin: !PC14
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200 
position_min: 0
position_endstop: 306
position_max: 306
homing_speed: 80
homing_retract_dist: 0
homing_positive_dir: true
endstop_pin: ^fly:PA2

[tmc2240 stepper_x]
cs_pin: PC13
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
diag0_pin: !PF4
run_current: 1.6
interpolate: false
stealthchop_threshold: 0
driver_SGT: 0

#Motor2
[stepper_y]
step_pin: PE2
dir_pin: PE1
enable_pin: !PE4
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200 
position_min: 0
position_endstop: 307
position_max: 307
homing_speed: 80
homing_retract_dist: 0
homing_positive_dir: true
endstop_pin: PF1

[tmc2240 stepper_y]
cs_pin: PE3
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
diag0_pin: !PF3
run_current: 1.6
interpolate: false
stealthchop_threshold: 0
driver_SGT: 0

#Motor3a
[stepper_z]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PE0
rotation_distance: 4
microsteps: 32
endstop_pin: probe:z_virtual_endstop
position_max: 350
position_min: -25
homing_speed: 8.0
second_homing_speed: 3
#homing_retract_dist: 3
homing_retract_dist: 0

[tmc2240 stepper_z]
cs_pin: PB9
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: false
run_current: 0.8
stealthchop_threshold: 0

#Motor4
[stepper_z1]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB6
rotation_distance: 4
microsteps: 32

[tmc2240 stepper_z1]
cs_pin: PB5
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: false
run_current: 0.8
stealthchop_threshold: 0

#Motor5
[stepper_z2]
step_pin: PG13
dir_pin: !PG12
enable_pin: !PG15
rotation_distance: 4
microsteps: 32

[tmc2240 stepper_z2]
cs_pin: PG14
spi_software_mosi_pin: PG6
spi_software_miso_pin: PG7
spi_software_sclk_pin: PG8
interpolate: false
run_current: 0.8
stealthchop_threshold: 0

[fan_generic bedfan]
pin: PA4
kick_start_time: 0.5

[safe_z_home]
home_xy_position:150,150
#speed:50
z_hop: 3

[z_tilt]
z_positions:
   -50, 18
   150, 348
   350, 18
points:
   30, 5
   150, 245
   270, 5

speed: 200
horizontal_move_z: 21.85
retries: 5
retry_tolerance: 0.009

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#